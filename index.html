<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Trip Map</title>
    <meta name="description" content="Interactive trip map generated from list.md and hotel.txt" />
    <meta name="theme-color" content="#020617" />

    <link rel="manifest" href="./manifest.webmanifest" />
    <link rel="icon" href="./assets/icons/icon-192.png" />
    <link rel="apple-touch-icon" href="./assets/icons/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Trip Map" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
    />

    <style>
      :root {
        color-scheme: dark;
      }
      html,
      body {
        height: 100%;
        font-family:
          Inter,
          "Noto Sans JP",
          ui-sans-serif,
          system-ui,
          -apple-system,
          "Segoe UI",
          Roboto,
          Helvetica,
          Arial,
          "Apple Color Emoji",
          "Segoe UI Emoji";
      }

      .leaflet-container {
        background: #0b1020;
      }
      .leaflet-control-attribution {
        background: rgba(2, 6, 23, 0.6) !important;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 999px;
        margin: 10px !important;
        padding: 4px 10px !important;
        color: rgba(226, 232, 240, 0.8) !important;
      }
      .leaflet-control-attribution a {
        color: rgba(226, 232, 240, 0.9) !important;
        text-decoration: none;
      }

      .leaflet-popup-content-wrapper,
      .leaflet-popup-tip {
        background: rgba(2, 6, 23, 0.92) !important;
        color: rgba(226, 232, 240, 0.95) !important;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 30px 80px rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(14px);
      }
      .leaflet-popup-content {
        margin: 14px 16px !important;
      }

      .pin {
        width: 34px;
        height: 34px;
        transform: translate(-50%, -100%);
        filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.55));
      }
      .pin__bubble {
        width: 34px;
        height: 34px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        box-shadow:
          inset 0 0 0 1px rgba(0, 0, 0, 0.25),
          0 12px 30px rgba(0, 0, 0, 0.35);
      }
      .pin__dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.85);
        box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.16);
      }
      .pin--selected .pin__bubble {
        box-shadow:
          0 0 0 10px rgba(236, 72, 153, 0.16),
          0 0 0 2px rgba(236, 72, 153, 0.35),
          0 20px 40px rgba(0, 0, 0, 0.55);
      }

      .cluster {
        width: 42px;
        height: 42px;
        transform: translate(-50%, -50%);
        border-radius: 999px;
        display: grid;
        place-items: center;
        font-weight: 800;
        letter-spacing: -0.02em;
        color: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.18);
        box-shadow:
          inset 0 0 0 1px rgba(0, 0, 0, 0.3),
          0 18px 40px rgba(0, 0, 0, 0.45);
        backdrop-filter: blur(10px);
      }

      .day-num {
        width: 28px;
        height: 28px;
        transform: translate(-50%, -50%);
        border-radius: 999px;
        display: grid;
        place-items: center;
        font-weight: 900;
        font-size: 12px;
        letter-spacing: -0.02em;
        color: rgba(255, 255, 255, 0.96);
        background: linear-gradient(135deg, rgba(236, 72, 153, 0.95), rgba(34, 211, 238, 0.85));
        border: 1px solid rgba(255, 255, 255, 0.22);
        box-shadow:
          inset 0 0 0 1px rgba(0, 0, 0, 0.28),
          0 16px 36px rgba(0, 0, 0, 0.45);
        backdrop-filter: blur(10px);
      }
      .day-num.day-num--visited {
        opacity: 0.55;
        filter: saturate(0.6);
      }

      .my-loc {
        position: relative;
        width: 18px;
        height: 18px;
        filter: drop-shadow(0 12px 22px rgba(0, 0, 0, 0.45));
      }
      .my-loc__dot {
        position: absolute;
        inset: 0;
        border-radius: 999px;
        background: rgba(34, 211, 238, 0.95);
        border: 2px solid rgba(255, 255, 255, 0.92);
        box-shadow:
          0 0 0 6px rgba(34, 211, 238, 0.16),
          0 18px 40px rgba(0, 0, 0, 0.35);
      }
      .my-loc__pulse {
        position: absolute;
        left: 50%;
        top: 50%;
        width: 18px;
        height: 18px;
        border-radius: 999px;
        background: rgba(34, 211, 238, 0.25);
        transform: translate(-50%, -50%) scale(1);
        animation: myloc-pulse 1.9s ease-out infinite;
      }
      @keyframes myloc-pulse {
        0% {
          transform: translate(-50%, -50%) scale(1);
          opacity: 0.65;
        }
        100% {
          transform: translate(-50%, -50%) scale(3.2);
          opacity: 0;
        }
      }

      #btnLocate[data-active="true"] {
        background: rgba(34, 211, 238, 0.14) !important;
        box-shadow:
          inset 0 0 0 1px rgba(34, 211, 238, 0.28),
          0 14px 30px rgba(0, 0, 0, 0.22);
      }
      #btnLocate[data-active="true"]:hover {
        background: rgba(34, 211, 238, 0.18) !important;
      }

      #btnFollow[data-active="true"] {
        background: rgba(236, 72, 153, 0.16) !important;
        box-shadow:
          inset 0 0 0 1px rgba(236, 72, 153, 0.32),
          0 14px 30px rgba(0, 0, 0, 0.22);
      }
      #btnFollow[data-active="true"]:hover {
        background: rgba(236, 72, 153, 0.2) !important;
      }

      #toast[data-clickable="true"] {
        cursor: pointer;
      }
      #toast[data-clickable="true"]:active {
        transform: scale(0.99);
      }

      .trip-sheet {
        height: 100dvh;
        transform: translate3d(0, var(--sheet-y, 0px), 0);
        transition: transform 280ms cubic-bezier(0.2, 0.85, 0.2, 1);
        will-change: transform;
      }
      .trip-sheet.is-dragging {
        transition: none;
      }
      #sheet[data-sheet-snap="full"] > div {
        border-radius: 0 !important;
      }
      .sheet-scroll {
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
        padding-bottom: calc(env(safe-area-inset-bottom) + 14px);
      }
      @media (min-width: 768px) {
        .trip-sheet {
          height: 100% !important;
          transform: none !important;
          transition: none !important;
        }
        .sheet-scroll {
          padding-bottom: 0;
        }
      }
    </style>

    <style type="text/tailwindcss">
      @layer base {
        :root {
          --bg-a: 2 6 23; /* slate-950 */
        }
      }
    </style>
  </head>

  <body class="bg-slate-950 text-slate-50">
    <div class="pointer-events-none fixed inset-0 -z-10 overflow-hidden">
      <div
        class="absolute -left-32 -top-36 h-[420px] w-[420px] rounded-full bg-fuchsia-500/25 blur-3xl"
      ></div>
      <div
        class="absolute -right-32 top-16 h-[520px] w-[520px] rounded-full bg-cyan-400/18 blur-3xl"
      ></div>
      <div
        class="absolute left-1/3 top-2/3 h-[520px] w-[520px] rounded-full bg-rose-500/16 blur-3xl"
      ></div>
      <div class="absolute inset-0 bg-[radial-gradient(circle_at_top,#0b1020,transparent_60%)]"></div>
    </div>

    <div class="h-dvh w-full overflow-hidden">
      <div class="flex h-full w-full flex-col md:flex-row">
        <aside
          id="sheet"
          class="trip-sheet fixed inset-x-0 bottom-0 z-[1200] w-full overflow-hidden md:static md:z-auto md:h-full md:w-[420px] md:shrink-0 md:border-r md:border-white/10"
        >
          <div
            class="flex h-full flex-col rounded-t-3xl border border-white/10 bg-slate-950/70 backdrop-blur-xl md:rounded-none md:border-0 md:bg-slate-950/60"
          >
            <div
              id="sheetHandle"
              class="md:hidden touch-none cursor-grab select-none px-4 pt-2 pb-2 active:cursor-grabbing"
            >
              <div class="mx-auto h-1.5 w-12 rounded-full bg-white/15 ring-1 ring-white/10"></div>
            </div>

            <div id="sheetHeader" class="border-b border-white/10 px-4 py-2 md:py-4">
              <div class="flex items-center justify-between gap-3">
                <div class="min-w-0">
                  <div class="text-base font-extrabold tracking-tight md:text-xl">Trip Map</div>
                  <div class="hidden text-xs text-slate-300 md:block">
                    `list.md` / `hotel.txt` → pins (Seoul)
                  </div>
                </div>
                <div class="flex flex-wrap items-center justify-end gap-2">
                  <button
                    id="btnFollow"
                    class="inline-flex items-center gap-2 rounded-full bg-white/10 px-3 py-2 text-xs font-semibold text-white ring-1 ring-white/10 transition hover:bg-white/15 active:scale-[0.99]"
                    type="button"
                    title="Follow my location"
                  >
                    Follow
                  </button>
                  <button
                    id="btnTheme"
                    class="inline-flex items-center gap-2 rounded-full bg-white/10 px-3 py-2 text-xs font-semibold text-white ring-1 ring-white/10 transition hover:bg-white/15 active:scale-[0.99]"
                    type="button"
                    title="Change map theme"
                  >
                    Theme
                  </button>
                  <button
                    id="btnFit"
                    class="inline-flex items-center gap-2 rounded-full bg-white/10 px-3 py-2 text-xs font-semibold text-white ring-1 ring-white/10 transition hover:bg-white/15 active:scale-[0.99]"
                    type="button"
                    title="全ピンが見えるように移動"
                  >
                    Fit
                  </button>
                  <button
                    id="btnLocate"
                    class="inline-flex items-center gap-2 rounded-full bg-white/10 px-3 py-2 text-xs font-semibold text-white ring-1 ring-white/10 transition hover:bg-white/15 active:scale-[0.99]"
                    type="button"
                    title="現在地を表示"
                  >
                    Locate
                  </button>
                </div>
              </div>

              <div class="mt-2 flex items-center gap-2">
                <label class="flex-1">
                  <span class="sr-only">Search</span>
                  <input
                    id="search"
                    type="search"
                    placeholder="Search (name / area)…"
                    class="w-full rounded-2xl bg-white/5 px-4 py-2.5 text-sm text-white placeholder:text-slate-400 ring-1 ring-white/10 outline-none transition focus:ring-2 focus:ring-fuchsia-400/60"
                  />
                </label>
                <button
                  id="btnClearSearch"
                  type="button"
                  class="rounded-2xl bg-white/5 px-3 py-2.5 text-sm text-slate-200 ring-1 ring-white/10 transition hover:bg-white/10"
                  title="検索をクリア"
                >
                  ✕
                </button>
              </div>
            </div>

            <div class="sheet-scroll min-h-0 flex-1 overflow-auto">
              <div
                id="sheetTop"
                class="sticky top-0 z-10 border-b border-white/10 bg-slate-950/60 backdrop-blur-xl"
              >
                <div class="flex items-center gap-2 px-4 pt-3 pb-2">
                  <div class="inline-flex rounded-full bg-white/5 p-1 ring-1 ring-white/10">
                    <button
                      id="tabPlaces"
                      type="button"
                      class="rounded-full px-3 py-1.5 text-xs font-extrabold text-white transition data-[active=true]:bg-white/10"
                      data-active="true"
                    >
                      Places
                    </button>
                    <button
                      id="tabPlanner"
                      type="button"
                      class="rounded-full px-3 py-1.5 text-xs font-extrabold text-white/80 transition hover:text-white data-[active=true]:bg-white/10 data-[active=true]:text-white"
                      data-active="false"
                    >
                      Planner
                    </button>
                  </div>
                </div>

                <div id="placesHeader" class="px-4 pb-3">
                  <button
                    id="btnToggleCategories"
                    type="button"
                    class="flex w-full items-center justify-between rounded-2xl bg-white/5 px-3 py-2 text-xs font-semibold text-white ring-1 ring-white/10 transition hover:bg-white/10"
                    title="Toggle categories"
                  >
                    <span>Categories</span>
                    <span class="flex items-center gap-2">
                      <span
                        id="categorySummary"
                        class="rounded-full bg-white/10 px-2 py-0.5 text-[10px] font-bold text-slate-200 ring-1 ring-white/10"
                        >All</span
                      >
                      <span id="categoryCaret" class="text-slate-300">▾</span>
                    </span>
                  </button>
                  <div id="categoryWrap" class="mt-2 max-h-44 overflow-auto pr-1 hidden md:block">
                    <div class="grid grid-cols-2 gap-2" id="categoryChips"></div>
                  </div>
                  <div class="mt-2 text-xs text-slate-300" id="stats"></div>
                </div>

                <div id="plannerHeader" class="hidden px-4 pb-3">
                  <div class="flex items-center justify-between gap-3">
                    <div class="text-xs font-semibold text-slate-300">Days</div>
                    <div class="flex items-center gap-2">
                      <button
                        id="btnDayDelete"
                        type="button"
                        class="rounded-full bg-white/5 px-3 py-1.5 text-xs font-semibold text-slate-200 ring-1 ring-white/10 transition hover:bg-white/10"
                        title="Delete active day"
                      >
                        Delete
                      </button>
                      <button
                        id="btnDayAdd"
                        type="button"
                        class="rounded-full bg-white/10 px-3 py-1.5 text-xs font-semibold text-white ring-1 ring-white/10 transition hover:bg-white/15"
                      >
                        + Day
                      </button>
                    </div>
                  </div>
                  <div class="mt-2 flex flex-wrap gap-2" id="plannerDays"></div>
                  <div class="mt-3 flex flex-wrap gap-2">
                    <button
                      id="btnPlanRoute"
                      type="button"
                      class="rounded-full bg-white/10 px-3 py-1.5 text-xs font-semibold text-white ring-1 ring-white/10 transition hover:bg-white/15"
                      title="Open route in Google Maps"
                    >
                      Route
                    </button>
                    <button
                      id="btnPlanFit"
                      type="button"
                      class="rounded-full bg-white/10 px-3 py-1.5 text-xs font-semibold text-white ring-1 ring-white/10 transition hover:bg-white/15"
                      title="Fit map to this day"
                    >
                      Fit
                    </button>
                    <button
                      id="btnPlanExport"
                      type="button"
                      class="rounded-full bg-white/10 px-3 py-1.5 text-xs font-semibold text-white ring-1 ring-white/10 transition hover:bg-white/15"
                      title="Export planner JSON"
                    >
                      Export
                    </button>
                    <label
                      class="cursor-pointer rounded-full bg-white/10 px-3 py-1.5 text-xs font-semibold text-white ring-1 ring-white/10 transition hover:bg-white/15"
                      title="Import planner JSON"
                    >
                      Import
                      <input id="planImport" type="file" accept="application/json" class="hidden" />
                    </label>
                    <button
                      id="btnDayClear"
                      type="button"
                      class="rounded-full bg-white/5 px-3 py-1.5 text-xs font-semibold text-slate-200 ring-1 ring-white/10 transition hover:bg-white/10"
                      title="Clear places in active day"
                    >
                      Clear
                    </button>
                  </div>
                </div>
              </div>

              <div id="panelPlaces">
                <div class="p-2" id="placeList"></div>
              </div>

              <div id="panelPlanner" class="hidden">
                <div class="p-2" id="plannerItems"></div>
              </div>
            </div>

            <div class="hidden border-t border-white/10 px-4 py-3 text-[11px] text-slate-400 md:block">
              データ更新: <span class="font-mono">node scripts/generate-places.mjs</span>
            </div>
          </div>
        </aside>

        <main class="relative min-h-0 flex-1">
          <div id="map" class="h-full w-full"></div>

          <div class="pointer-events-none absolute inset-0">
            <div class="absolute inset-x-0 top-0 h-24 bg-gradient-to-b from-slate-950/70 to-transparent">
            </div>
            <div
              class="absolute inset-x-0 bottom-0 h-24 bg-gradient-to-t from-slate-950/70 to-transparent"
            ></div>
          </div>

          <div class="pointer-events-none absolute left-1/2 top-4 z-[1100] -translate-x-1/2">
            <div
              id="toast"
              class="pointer-events-auto hidden rounded-full bg-black/50 px-4 py-2 text-xs font-semibold text-slate-100 ring-1 ring-white/10 backdrop-blur-xl"
            ></div>
          </div>
        </main>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script type="module" src="./app.js"></script>
  </body>
</html>
